---
title: 'Build a external link previewer'
date: 2022-10-19T20:05:46.234Z
status: draft
keywords: 'tailwind css, next-themes, nextjs, react, javascript, theme toggle'
author: 'Arikko'
---

1. Initial draft
2. Why we should use link preview
3. How to build a link preview with playwright, radix-ui, tailwindcss and nextjs
4. How to use link preview in your project
5. Conclusion

## Why we should use link preview

While reading any article or blog post, there are many external links. But whenever we open we get distracted from the main content. So, we should have a preview of the link before opening it on hover or focus. This will help us to decide whether to open the link or not. And also to keep the attention on the main content.

The main idea came from [Rauno's](https://twitter.com/raunofreiberg) [uiwtf](https://uiw.tf/link-preview) project. Whenever we hover on the link, it will show the preview `screenshot` of the link. This is the main idea of the link preview.

## First code approach

There are many ways of building this particular feature, but on the first approach I tried to using it on server-side. Like building an `/api/link-preview` endpoint and pass the link as a query parameter. Then, I used [playwright](https://playwright.dev/) to take the screenshot of the link and return it as a base64 string. But this approach has some drawbacks. Like, it will take more time to load the page and also it will take more time to take the screenshot. So, I decided to use the client-side approach. And also it's little bit tricky to host it in [vercel](https://vercel.com).

Playwright is a Node.js library to automate Chromium, Firefox, and WebKit with a single API. It enables cross-browser web automation that is ever-green, capable, reliable and fast.

## Extracting links from the content using regex

I'm using [contentlayer]() to convert the content from the markdown files. So, I need to extract the links from the content.

Contentlayer is a content preprocessor that validates and transforms your content into type-safe JSON you can easily import into your application.

I used the following regex to extract the links from the content.

```typescript
// https://morioh.com/p/2f455138edf8
const regXExternalLink =
  /\[(.+)\]\((https?:\/\/[^\s]+)(?: "(.+)")?\)|(https?:\/\/[^\s]+)/gi;
```

This is how my `contentlayer.config.ts` looks like. You can check the full code [here]().

```typescript:contentlayer.config.ts {15} showLineNumbers
import { ComputedFields } from 'contentlayer/source-files';

const computedFields: ComputedFields = {
  // ...
  externalLinks: {
    type: 'json',
    resolve: async doc => {
      // https://morioh.com/p/2f455138edf8
      const regXExternalLink =
        /\[(.+)\]\((https?:\/\/[^\s]+)(?: "(.+)")?\)|(https?:\/\/[^\s]+)/gi;

      const externalLinks = Array.from(
        doc.body.raw.matchAll(regXExternalLink)
      ).map((value: any) => {
        const text = value[1];
        const url = value[2];
        if (!url) return;
        // Replacing all the / with @ to avoid folder structure
        const name = (url as string).replace(/[\/#]/g, '@');

        return {
          text,
          url,
          name,
        };
      });

      return externalLinks;
    },
  },
};
```

## Taking the screenshot using playwright

For now I'm manually running the script to take the screenshot of all of the links and storing them in the `public/previews` folder. But I'm planning to automate the process of taking the screenshot.

```javascript:preview-images.mjs
import { readFileSync } from 'fs';
import { chromium } from 'playwright-core';

const allWritings = readFileSync(
  '.contentlayer/generated/Writing/_index.json',
  'utf8'
);

function previewImages() {
  JSON.parse(allWritings).map(writing => {
    writing.externalLinks.map(async externalLink => {
      let browser = await chromium.launch();

      let page = await browser.newPage();
      await page.setViewportSize({ width: 1440, height: 1080 });
      await page.emulateMedia({ colorScheme: 'dark' });
      await page.goto(externalLink.url);
      await page.waitForTimeout(1000);
      await page.screenshot({
        path: `public/previews/${externalLink.name}.png`,
      });
      await browser.close();
    });
  });
}

previewImages();
```
